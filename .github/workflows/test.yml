name: üß™ Manual Test Build

# Trigger manually from the Actions tab
on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test-android-release:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

#      # Recommended: Keep Java setup to prevent environment mismatch errors
#      - name: ‚òï Setup Java
#        uses: actions/setup-java@v4
#        with:
#          distribution: 'temurin'
#          java-version: '17'

      - name: üê¶ Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: üîê Decode Keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/upload-keystore.jks

      - name: üî• Decode Firebase Config (Prod)
        run: |
          mkdir -p android/app/src/release
          echo "${{ secrets.FIREBASE_JSON_RELEASE }}" | base64 --decode > android/app/src/release/google-services.json

      - name: üì± Build Signed APK (Prod)
        env:
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
        run: >
          flutter build apk --split-per-abi --release
          --build-number ${{ github.run_number }}
          --dart-define=API_LINK=${{ secrets.API_LINK }}
          --dart-define=ENVIRONMENT=prod

      # Renames files using the Git Tag as version
      - name: üè∑Ô∏è Rename APKs
        run: |
          cd build/app/outputs/flutter-apk/
          
          # Use the input from workflow_dispatch
          VERSION="${{ github.ref_name }}"
          
          # Loop through split APKs (e.g., app-armeabi-v7a-release.apk)
          for file in app-*-release.apk; do
            # Extract Arch (remove 'app-' and '-release.apk')
            ARCH="${file#app-}"
            ARCH="${ARCH%-release.apk}"

            # Rename to NextBus-v1.0.0-armeabi-v7a.apk
            mv "$file" "NextBus-${VERSION}-${ARCH}.apk"
          done
          
          ls -la

      - name: üì¶ Upload Release APKs
        uses: actions/upload-artifact@v4
        with:
          name: release-apks-${{ github.ref_name }}
          path: build/app/outputs/flutter-apk/NextBus-*.apk
          retention-days: 3